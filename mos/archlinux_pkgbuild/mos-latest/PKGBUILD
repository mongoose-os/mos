pkgname=mos-latest
pkgver=autogenerated_below
pkgrel=1
pkgdesc="Mongoose-OS build tool (latest)"
arch=('i686' 'x86_64')
license=('Apache')
url="https://mongoose-os.com/software.html"
depends=('libftdi-compat' 'libusb')
makedepends=(
    'go'
    'git'
    'python'
    'jshon'
)
conflicts=('mos')

source=(git+https://github.com/mongoose-os/mos.git#branch=master)

md5sums=('SKIP')

prepare() {
    rm -rf "$srcdir/go/src"
    mkdir -p "$srcdir/go/src/github.com/mongoose-os"
    mv "$srcdir/mos" "$srcdir/go/src/github.com/mongoose-os"
}

pkgver() {
    cd "$srcdir/go/src/github.com/mongoose-os/mos/mos"
    rm -f version/version.json
    make version/version.go > /dev/null 2>&1
    jshon -F version/version.json -e build_version -u
}

build() {
    export GOPATH="$srcdir/go"
    export PATH="$srcdir/go/bin:$PATH"
    cd "$srcdir/go/src/github.com/mongoose-os/mos"
    go get -u github.com/kardianos/govendor
    govendor sync -v
    make build
}

package() {
    install -D "$srcdir/go/src/github.com/mongoose-os/mos/mos/mos" "$pkgdir/usr/bin/mos"
}
